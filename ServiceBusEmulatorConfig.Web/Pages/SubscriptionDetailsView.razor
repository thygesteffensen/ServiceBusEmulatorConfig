@if (Subscription == null)
{
    <MudText>No subscription selected</MudText>
}
else
{
    <MudStack>
        <MudText Typo="Typo.h5" Color="Color.Primary">
            <MudIcon Icon="@Icons.Material.Filled.Topic" Class="mr-2" /> Topic: @Subscription.TopicName
        </MudText>
        
        @if (ParentTopic != null)
        {
            <MudDivider />
            
            <MudText Typo="Typo.h6">Topic Properties</MudText>
            
            <MudSimpleTable Hover="true" Dense="true" Bordered="true">
                <tbody>
                    <tr>
                        <td><strong>Auto Delete On Idle</strong></td>
                        <td>@ParentTopic.Properties.AutoDeleteOnIdle</td>
                    </tr>
                    <tr>
                        <td><strong>Default Message TTL</strong></td>
                        <td>@ParentTopic.Properties.DefaultMessageTimeToLive</td>
                    </tr>
                    <tr>
                        <td><strong>Duplicate Detection History Time Window</strong></td>
                        <td>@ParentTopic.Properties.DuplicateDetectionHistoryTimeWindow</td>
                    </tr>
                    <tr>
                        <td><strong>Enable Batched Operations</strong></td>
                        <td>@(ParentTopic.Properties.EnableBatchedOperations ? "Yes" : "No")</td>
                    </tr>
                    <tr>
                        <td><strong>Enable Partitioning</strong></td>
                        <td>@(ParentTopic.Properties.EnablePartitioning ? "Yes" : "No")</td>
                    </tr>
                    <tr>
                        <td><strong>Max Size In Megabytes</strong></td>
                        <td>@ParentTopic.Properties.MaxSizeInMegabytes</td>
                    </tr>
                    <tr>
                        <td><strong>Requires Duplicate Detection</strong></td>
                        <td>@(ParentTopic.Properties.RequiresDuplicateDetection ? "Yes" : "No")</td>
                    </tr>
                    <tr>
                        <td><strong>Status</strong></td>
                        <td>@ParentTopic.Properties.Status</td>
                    </tr>
                </tbody>
            </MudSimpleTable>
            
            <MudText Typo="Typo.h6">Topic Runtime Properties</MudText>
            
            <MudSimpleTable Hover="true" Dense="true" Bordered="true">
                <tbody>
                    <tr>
                        <td><strong>Size In Bytes</strong></td>
                        <td>@ParentTopic.RuntimeProperties.SizeInBytes</td>
                    </tr>
                    <tr>
                        <td><strong>Created At</strong></td>
                        <td>@ParentTopic.RuntimeProperties.CreatedAt</td>
                    </tr>
                    <tr>
                        <td><strong>Updated At</strong></td>
                        <td>@ParentTopic.RuntimeProperties.UpdatedAt</td>
                    </tr>
                    <tr>
                        <td><strong>Accessed At</strong></td>
                        <td>@ParentTopic.RuntimeProperties.AccessedAt</td>
                    </tr>
                    <tr>
                        <td><strong>Subscription Count</strong></td>
                        <td>@ParentTopic.RuntimeProperties.SubscriptionCount</td>
                    </tr>
                </tbody>
            </MudSimpleTable>
            
            <MudDivider />
        }
        <MudText Typo="Typo.h5" Color="Color.Primary">
            <MudIcon Icon="@Icons.Material.Filled.Notifications" Class="mr-2" /> @Subscription.Name
        </MudText>
        
        <MudDivider />
        
        <MudText Typo="Typo.h6">Properties</MudText>
        
        <MudSimpleTable Hover="true" Dense="true" Bordered="true">
            <tbody>
                <tr>
                    <td><strong>Requires Session</strong></td>
                    <td>@(Subscription.Properties.RequiresSession ? "Yes" : "No")</td>
                </tr>
                <tr>
                    <td><strong>Dead Lettering on Message Expiration</strong></td>
                    <td>@(Subscription.Properties.DeadLetteringOnMessageExpiration ? "Yes" : "No")</td>
                </tr>
                <tr>
                    <td><strong>Default Message TTL</strong></td>
                    <td>@Subscription.Properties.DefaultMessageTimeToLive</td>
                </tr>
                <tr>
                    <td><strong>Lock Duration</strong></td>
                    <td>@Subscription.Properties.LockDuration</td>
                </tr>
                <tr>
                    <td><strong>Max Delivery Count</strong></td>
                    <td>@Subscription.Properties.MaxDeliveryCount</td>
                </tr>
                <tr>
                    <td><strong>Forward To</strong></td>
                    <td>@(string.IsNullOrEmpty(Subscription.Properties.ForwardTo) ? "-" : Subscription.Properties.ForwardTo)</td>
                </tr>
                <tr>
                    <td><strong>Forward Dead Lettered Messages To</strong></td>
                    <td>@(string.IsNullOrEmpty(Subscription.Properties.ForwardDeadLetteredMessagesTo) ? "-" : Subscription.Properties.ForwardDeadLetteredMessagesTo)</td>
                </tr>
                <tr>
                    <td><strong>Message Count</strong></td>
                    <td>?</td>
                </tr>
            </tbody>
        </MudSimpleTable>

        <MudDivider Class="my-3" />
        
        <MudText Typo="Typo.h6">Rules (@(Subscription.Rules != null ? Subscription.Rules.Count : 0))</MudText>
        
        @if (Subscription.Rules.Count == 0)
        {
            <MudAlert Severity="Severity.Info">No rules for this subscription</MudAlert>
        }
        else
        {
            <MudSimpleTable Hover="true" Dense="true" Bordered="true">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Filter Type</th>
                        <th>Filter Expression</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var rule in Subscription.Rules)
                    {
                        <tr>
                            <td>@rule.Name</td>
                            <td>@(rule.Filter?.GetType().Name ?? "Unknown")</td>
                            <td>
                                @if (rule.Filter?.GetType().Name == "SqlRuleFilter")
                                {
                                    <span>SQL Filter: @(rule.Action?.ToString() ?? "-")</span>
                                }
                                else if (rule.Filter?.GetType().Name == "CorrelationRuleFilter")
                                {
                                    <MudButton Size="Size.Small" 
                                              Variant="Variant.Outlined" 
                                              Color="Color.Primary"
                                              OnClick="@(() => ShowCorrelationFilterDetails(rule))">
                                        View Filter Details
                                    </MudButton>
                                }
                                else if (rule.Filter?.GetType().Name == "TrueRuleFilter")
                                {
                                    <span>True Filter (matches all messages)</span>
                                }
                                else if (rule.Filter?.GetType().Name == "FalseRuleFilter")
                                {
                                    <span>False Filter (matches no messages)</span>
                                }
                                else
                                {
                                    <span>@(rule.Filter?.ToString() ?? "Unknown filter type")</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        }
    </MudStack>
}

@if (_showCorrelationFilterDialog && _selectedRule != null)
{
    <MudDialog Open="true" DisableSidePadding="true">
        <TitleContent>
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.FilterList" Class="mr-2" />
                Correlation Filter Details: @_selectedRule.Action
            </MudText>
        </TitleContent>
        <DialogContent>
            <MudSimpleTable Hover="true" Dense="true">
                <tbody>
                    @if (_selectedRule.Filter != null)
                    {
                        <tr>
                            <td><strong>Filter Type</strong></td>
                            <td>@_selectedRule.Filter.GetType().Name</td>
                        </tr>
                        <tr>
                            <td><strong>Action Type</strong></td>
                            <td>@(_selectedRule.Action?.GetType().Name ?? "None")</td>
                        </tr>
                        
                        @if (_selectedRule.Filter.GetType().Name == "SqlRuleFilter")
                        {
                            <tr>
                                <td><strong>SQL Expression</strong></td>
                                <td>@_selectedRule.Action?.ToString()</td>
                            </tr>
                        }
                        else if (_selectedRule.Filter.GetType().Name == "CorrelationRuleFilter")
                        {
                            <tr>
                                <td colspan="2"><strong>Correlation Properties</strong></td>
                            </tr>
                            <tr>
                                <td><strong>Properties</strong></td>
                                <td>@_selectedRule.Filter.ToString()</td>
                            </tr>
                        }
                    }
                </tbody>
            </MudSimpleTable>
        </DialogContent>
        <DialogActions>
            <MudButton Color="Color.Primary" OnClick="CloseDialog">Close</MudButton>
        </DialogActions>
    </MudDialog>
}

@code {
    [Parameter]
    public Subscription? Subscription { get; set; }
    
    [Parameter]
    public Topic? ParentTopic { get; set; }
    
    private bool _showCorrelationFilterDialog;
    private RuleProperties? _selectedRule;
    
    private void ShowCorrelationFilterDetails(RuleProperties rule)
    {
        _selectedRule = rule;
        _showCorrelationFilterDialog = true;
    }
    
    private void CloseDialog()
    {
        _showCorrelationFilterDialog = false;
        _selectedRule = null;
    }
}
